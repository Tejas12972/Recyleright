{% extends "layout.html" %}

{% block title %}Recycling Centers - RecycleRight{% endblock %}

{% block styles %}
<style>
    #map {
        width: 100%;
        height: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .search-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    
    .search-card .card-body {
        padding: 1.5rem;
    }
    
    .center-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .center-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    
    .center-card .card-body {
        padding: 1.25rem;
    }
    
    .center-card h5 {
        color: #2D6A4F;
        margin-bottom: 0.75rem;
    }
    
    .badge.bg-success {
        background-color: #2D6A4F !important;
        font-weight: 500;
        padding: 0.4rem 0.6rem;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .btn-outline-primary {
        color: #2D6A4F;
        border-color: #2D6A4F;
    }
    
    .btn-outline-primary:hover {
        background-color: #2D6A4F;
        border-color: #2D6A4F;
    }
    
    .info-window {
        min-width: 250px;
        max-width: 300px;
        padding: 5px;
    }
    
    .info-window h5 {
        color: #2D6A4F;
        margin-bottom: 10px;
        border-bottom: 2px solid #E9F7EF;
        padding-bottom: 8px;
    }
    
    .info-window p {
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .info-window .badge {
        margin-bottom: 5px;
    }
    
    .highlight-card {
        border: 2px solid #2D6A4F;
        background-color: #E9F7EF;
    }
    
    .section-header {
        position: relative;
        margin-bottom: 2rem;
        color: #2D6A4F;
    }
    
    .section-header:after {
        content: '';
        position: absolute;
        left: 0;
        bottom: -10px;
        width: 50px;
        height: 3px;
        background-color: #2D6A4F;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="text-center mb-5">Find Recycling Centers Near You</h1>
    
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="card search-card">
                <div class="card-body">
                    <h5 class="card-title mb-3">Search by Location</h5>
                    {% if address %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-map-marker-alt"></i> Showing results near: <strong>{{ address }}</strong>
                    </div>
                    {% endif %}
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="address" class="form-label">Enter your address</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="address" name="address" placeholder="Enter address, city, or zip code">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Find Centers
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-7 mb-4">
            <h3 class="section-header">Interactive Map</h3>
            <div id="map">
                <div class="alert alert-warning text-center p-5">
                    <i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>
                    <h4>Map unavailable</h4>
                    <p>View the list of recycling centers below.</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-5 mb-4">
            <h3 class="section-header">Centers List</h3>
            <div class="centers-list" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                {% if centers and centers|length > 0 %}
                    {% for center in centers %}
                        <div class="card center-card mb-3" id="center-{{ loop.index }}">
                            <div class="card-body">
                                <h5 class="card-title">{{ center.name }}</h5>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt text-danger"></i> {{ center.address }}<br>
                                    <i class="fas fa-route text-info"></i> {{ "%.1f"|format(center.distance) }} miles away
                                </p>
                                <div class="mb-3">
                                    {% for item in center.accepts %}
                                        <span class="badge bg-success">{{ item }}</span>
                                    {% endfor %}
                                </div>
                                <div class="d-flex justify-content-between">
                                    <a href="https://maps.google.com/?q={{ center.address|urlencode }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-directions"></i> Directions
                                    </a>
                                    <button class="btn btn-success btn-sm view-on-map" data-index="{{ loop.index0 }}">
                                        <i class="fas fa-map-pin"></i> View on Map
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No recycling centers found in your area. Try adjusting your search.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-12">
            <div class="card search-card">
                <div class="card-body">
                    <h5 class="card-title">Recycling Tips</h5>
                    <p>Remember to clean and sort your recyclables before taking them to a recycling center. Many centers have specific requirements for the items they accept.</p>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-water fa-2x text-primary me-3"></i>
                                <span>Rinse containers before recycling</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-sort-amount-down fa-2x text-primary me-3"></i>
                                <span>Sort materials by type</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-compress-alt fa-2x text-primary me-3"></i>
                                <span>Flatten cardboard boxes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let map;
    let markers = [];
    let infoWindows = [];
    
    // Form handler for address search
    document.getElementById('locationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const address = document.getElementById('address').value;
        if (address) {
            window.location.href = "{{ url_for('centers') }}?address=" + encodeURIComponent(address);
        }
    });
</script>

{% if google_maps_api_key %}
<!-- Generate centers data with Jinja2 -->
<script id="centers-data" type="application/json">
{
    "location": {{ location|default('{"lat": 42.4072, "lng": -71.3824}')|safe }},
    "centers": [
    {% if centers %}
        {% for center in centers %}
            {% if center.lat and center.lon %}
            {
                "position": { 
                    "lat": {{ center.lat }}, 
                    "lng": {{ center.lon }}
                },
                "title": "{{ center.name|safe }}",
                "centerData": {
                    "index": {{ loop.index0 }},
                    "name": "{{ center.name|safe }}",
                    "address": "{{ center.address|safe }}",
                    "distance": "{{ "%.1f"|format(center.distance) }} miles",
                    "phone": "{{ center.phone|default('Not available')|safe }}",
                    "website": "{{ center.website|default('#')|safe }}",
                    "accepts": [{% for item in center.accepts %}"{{ item }}"{% if not loop.last %}, {% endif %}{% endfor %}]
                }
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
    ]
}
</script>

<script>
    // Pure JavaScript with no Jinja2 template syntax
    function initMap() {
        try {
            console.log("Initializing map...");
            // Get centers data from JSON
            const centersDataElement = document.getElementById('centers-data');
            let centersData;
            
            try {
                centersData = JSON.parse(centersDataElement.textContent);
                console.log("Centers data parsed:", centersData);
            } catch (e) {
                console.error("Error parsing centers data:", e);
                console.log("Raw centers data:", centersDataElement.textContent);
                // Use default data if parsing fails
                centersData = {
                    location: {"lat": 42.4072, "lng": -71.3824},
                    centers: []
                };
            }
            
            const locationData = centersData.location;
            const mapCenter = {
                lat: parseFloat(locationData.lat),
                lng: parseFloat(locationData.lng)
            };
            
            console.log("Map center:", mapCenter);
            
            // Create the map with improved styling
            map = new google.maps.Map(document.getElementById('map'), {
                center: mapCenter,
                zoom: 10,
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                styles: [
                    {
                        "featureType": "poi.business",
                        "stylers": [{ "visibility": "off" }]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text",
                        "stylers": [{ "visibility": "off" }]
                    }
                ]
            });
            
            console.log("Map created");
            
            // Add markers for each center
            if (centersData.centers && centersData.centers.length > 0) {
                console.log("Adding markers for", centersData.centers.length, "centers");
                centersData.centers.forEach((center, index) => {
                    if (center && center.position) {
                        console.log("Adding marker for center:", center.title);
                        addMarker(center);
                    }
                });
            } else {
                console.log("No centers found in data");
            }
        } catch (e) {
            console.error("Error in initMap:", e);
        }
    }
    
    function addMarker(props) {
        // Create custom marker icon for better visibility
        const markerIcon = {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#2D6A4F',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            scale: 10
        };
        
        // Create marker with animation
        const marker = new google.maps.Marker({
            position: props.position,
            map: map,
            title: props.title,
            icon: markerIcon,
            animation: google.maps.Animation.DROP
        });
        
        markers.push(marker);
        
        // Create info window with center details
        if (props.centerData) {
            // Create badges for accepted items
            const acceptsHtml = props.centerData.accepts.map(item => 
                `<span class="badge bg-success">${item}</span>`
            ).join(' ');
            
            // Create info window content
            const contentString = `
                <div class="info-window">
                    <h5>${props.centerData.name}</h5>
                    <p>
                        <i class="fas fa-map-marker-alt text-danger"></i> ${props.centerData.address}<br>
                        <i class="fas fa-route text-info"></i> ${props.centerData.distance}<br>
                        <i class="fas fa-phone text-success"></i> ${props.centerData.phone}
                    </p>
                    <p><strong>Accepts:</strong><br> ${acceptsHtml}</p>
                    <div class="d-flex justify-content-between mt-3">
                        <a href="https://maps.google.com/?q=${encodeURIComponent(props.centerData.address)}" 
                           target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-directions"></i> Directions
                        </a>
                        ${props.centerData.website !== '#' ? 
                            `<a href="${props.centerData.website}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-globe"></i> Website
                            </a>` : ''
                        }
                    </div>
                </div>
            `;
            
            const infoWindow = new google.maps.InfoWindow({
                content: contentString,
                maxWidth: 320
            });
            
            infoWindows.push(infoWindow);
            
            // Add click listener to marker
            marker.addListener('click', () => {
                // Close all open info windows
                infoWindows.forEach(window => window.close());
                
                // Open this info window
                infoWindow.open(map, marker);
                
                // Highlight corresponding card
                highlightCard(props.centerData.index);
                
                // Animate marker
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => marker.setAnimation(null), 750);
            });
        }
    }
    
    function highlightCard(index) {
        // Remove highlight from all cards
        document.querySelectorAll('.center-card').forEach(card => {
            card.classList.remove('highlight-card');
        });
        
        // Add highlight to selected card
        const card = document.getElementById(`center-${index + 1}`);
        if (card) {
            card.classList.add('highlight-card');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    // Connect list view buttons to the map
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handler to "View on Map" buttons
        document.querySelectorAll('.view-on-map').forEach(button => {
            button.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                
                if (markers[index]) {
                    // Center map on the marker
                    map.setCenter(markers[index].getPosition());
                    map.setZoom(14);
                    
                    // Trigger marker click
                    google.maps.event.trigger(markers[index], 'click');
                }
            });
        });
    });
</script>

<script>
    // Load Google Maps API when the page is fully loaded
    window.onload = function() {
        console.log("Window loaded, setting up map");
        
        if (typeof google === 'undefined') {
            console.log("Loading Google Maps API");
            // Clear the warning message
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = '';
            
            // Load the script
            const script = document.createElement('script');
            script.src = "https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap";
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            
            // Verify API key is present
            console.log("API Key length:", "{{ google_maps_api_key }}".length);
        } else {
            console.log("Google Maps API already loaded");
            initMap();
        }
    };
</script>
{% endif %}
{% endblock %} 