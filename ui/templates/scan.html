{% extends "layout.html" %}

{% block title %}Scan Waste - RecycleRight{% endblock %}

{% block styles %}
<style>
    .scan-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .nav-tabs .nav-link {
        border-radius: 0.5rem 0.5rem 0 0;
        background-color: rgba(255, 255, 255, 0.1);
        margin-right: 5px;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
    }
    
    .tab-content {
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 0 0.5rem 0.5rem 0.5rem;
        min-height: 400px;
    }
    
    #drop-area {
        border: 2px dashed #84c5ab;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        background-color: rgba(132, 197, 171, 0.1);
    }
    
    #drop-area.highlight {
        border-color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.1);
    }
    
    #file-input {
        display: none;
    }
    
    #preview {
        margin-top: 20px;
        text-align: center;
    }
    
    #preview img {
        max-width: 300px;
        max-height: 300px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    #camera-preview {
        width: 100%;
        max-width: 500px;
        height: auto;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Fix for upside down text in camera controls */
    .camera-controls button {
        transform: rotate(0deg);
        text-orientation: upright;
        writing-mode: horizontal-tb;
    }
    
    .camera-controls {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    
    .btn-capture {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
    }
    
    .btn-capture:hover {
        background-color: #3e8e41;
    }
    
    .btn-capture i {
        margin-right: 8px;
    }
    
    .loading-container {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #4CAF50;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .results-container {
        display: none;
        margin-top: 30px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 20px;
    }
    
    .results-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .results-header i {
        font-size: 2rem;
        margin-right: 15px;
        color: #4CAF50;
    }
    
    .waste-type {
        text-transform: capitalize;
        font-weight: bold;
        color: #4CAF50;
    }
    
    .confidence {
        color: #666;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    .guidelines {
        margin: 20px 0;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .recycling-centers {
        margin-top: 20px;
    }
    
    .center-card {
        margin-bottom: 10px;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .btn-next {
        margin-top: 20px;
        text-align: center;
    }
    
    .error-message {
        color: #f44336;
        text-align: center;
        margin: 20px 0;
        padding: 10px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 8px;
        display: none;
    }
    
    /* GPT Analysis Section Styles */
    .gpt-analysis {
        margin-top: 20px;
        padding: 15px;
        background-color: rgba(76, 175, 80, 0.05);
        border-radius: 8px;
        border-left: 4px solid #4CAF50;
    }
    
    .gpt-analysis h4 {
        color: #4CAF50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .gpt-analysis h4 i {
        margin-right: 10px;
    }
    
    .gpt-analysis-section {
        margin-bottom: 15px;
    }
    
    .gpt-analysis-section h5 {
        font-size: 1rem;
        color: #2E7D32;
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        padding-bottom: 5px;
    }
    
    .gpt-analysis-section ul {
        padding-left: 20px;
    }
    
    .gpt-analysis-section li {
        margin-bottom: 5px;
    }
    
    /* Badge styles for waste type */
    .badge-recyclable {
        background-color: #4CAF50;
        color: white;
    }
    
    .badge-compostable {
        background-color: #8BC34A;
        color: white;
    }
    
    .badge-trash {
        background-color: #F44336;
        color: white;
    }
    
    .badge-mixed {
        background-color: #FF9800;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="scan-container">
    <h1 class="text-center mb-4"><i class="fas fa-camera"></i> Scan Your Waste</h1>
    
    <p class="text-center mb-4">
        Take a photo or upload an image of your waste item for AI-powered classification 
        and get personalized recycling guidance.
    </p>
    
    <ul class="nav nav-tabs" id="scanTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" 
                    type="button" role="tab" aria-controls="upload" aria-selected="true">
                <i class="fas fa-upload"></i> Upload Image
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" 
                    type="button" role="tab" aria-controls="camera" aria-selected="false">
                <i class="fas fa-camera"></i> Use Camera
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="scanTabContent">
        <!-- Upload Tab -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
            <form id="upload-form">
                <div id="drop-area">
                    <p>Drag and drop an image file here, or click to select a file</p>
                    <input type="file" id="file-input" accept="image/*">
                    <button type="button" class="btn btn-primary mt-2" id="select-file-btn">
                        <i class="fas fa-file-image"></i> Select Image
                    </button>
                </div>
                
                <div id="preview"></div>
                
                <div class="text-center mt-3" id="upload-btn-container" style="display: none;">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-cloud-upload-alt"></i> Analyze Image
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Camera Tab -->
        <div class="tab-pane fade" id="camera" role="tabpanel" aria-labelledby="camera-tab">
            <div class="text-center mb-3">
                <video id="camera-preview" autoplay playsinline></video>
            </div>
            
            <div class="camera-controls">
                <button class="btn btn-primary" id="start-camera">
                    <i class="fas fa-video"></i> Start Camera
                </button>
                
                <button class="btn btn-success" id="capture-image" disabled>
                    <i class="fas fa-camera"></i> Capture Image
                </button>
                
                <button class="btn btn-secondary" id="switch-camera" disabled>
                    <i class="fas fa-sync-alt"></i> Switch to Front Camera
                </button>
            </div>
            
            <div id="camera-preview-container" class="text-center mt-3" style="display: none;">
                <canvas id="canvas" style="display: none;"></canvas>
                <div id="camera-result-preview"></div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-success" id="analyze-capture">
                        <i class="fas fa-search"></i> Analyze Image
                    </button>
                    <button class="btn btn-secondary" id="retake-image">
                        <i class="fas fa-redo"></i> Retake
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-container" id="loading">
        <div class="spinner"></div>
        <p class="mt-2">Analyzing your waste item...</p>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="error-message"></div>
    
    <!-- Results -->
    <div class="results-container" id="results">
        <div class="results-header">
            <i class="fas fa-recycle"></i>
            <h2>Analysis Results</h2>
        </div>
        
        <div class="alert alert-success">
            <p>This item is a <span class="waste-type" id="waste-type"></span> 
               <span class="confidence" id="confidence"></span></p>
            <p id="item-scanned"></p>
        </div>
        
        <div class="guidelines">
            <h4><i class="fas fa-info-circle"></i> Recycling Guidelines</h4>
            <div id="guidelines-content"></div>
        </div>
        
        <div class="recycling-centers">
            <h4><i class="fas fa-map-marker-alt"></i> Nearby Recycling Centers</h4>
            <div id="centers-list"></div>
        </div>
        
        <div class="btn-next">
            <button class="btn btn-success btn-lg me-2" id="confirm-disposal">
                <i class="fas fa-check-circle"></i> Confirm Proper Disposal
            </button>
            <button class="btn btn-primary btn-lg" id="scan-another">
                <i class="fas fa-redo"></i> Scan Another Item
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const preview = document.getElementById('preview');
        const uploadForm = document.getElementById('upload-form');
        const uploadBtnContainer = document.getElementById('upload-btn-container');
        
        const startCameraBtn = document.getElementById('start-camera');
        const captureImageBtn = document.getElementById('capture-image');
        const switchCameraBtn = document.getElementById('switch-camera');
        const videoElement = document.getElementById('camera-preview');
        const canvas = document.getElementById('canvas');
        const cameraResultPreview = document.getElementById('camera-result-preview');
        const cameraPreviewContainer = document.getElementById('camera-preview-container');
        const analyzeCapture = document.getElementById('analyze-capture');
        const retakeImage = document.getElementById('retake-image');
        
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        
        const wasteType = document.getElementById('waste-type');
        const confidence = document.getElementById('confidence');
        const guidelinesContent = document.getElementById('guidelines-content');
        const centersList = document.getElementById('centers-list');
        
        const confirmDisposal = document.getElementById('confirm-disposal');
        const scanAnother = document.getElementById('scan-another');
        
        let capturedImage = null;
        let stream = null;
        let currentFacingMode = 'environment'; // 'environment' for back camera, 'user' for front
        
        // File Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].type.match('image.*')) {
                handleFiles(files);
            } else {
                showError('Please upload an image file (JPEG, PNG, etc.)');
            }
        }
        
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
            }
        });
        
        function handleFiles(files) {
            const file = files[0];
            if (file.type.match('image.*')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    uploadBtnContainer.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
            } else {
                showError('Please select an image file (JPEG, PNG, etc.)');
                fileInput.value = '';
                preview.innerHTML = '';
                uploadBtnContainer.style.display = 'none';
            }
        }
        
        // Form submission
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (fileInput.files.length === 0) {
                showError('Please select an image first');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            showLoading();
            
            fetch('/scan/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Upload response status:", response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error("API error:", data);
                        throw new Error(data.error || 'Error analyzing image');
                    }).catch(err => {
                        console.error("JSON parse error:", err);
                        throw new Error('Error analyzing image: Invalid response format');
                    });
                }
                return response.json().catch(err => {
                    console.error("JSON parse error:", err);
                    throw new Error('Error analyzing image: Invalid response format');
                });
            })
            .then(data => {
                if (data.success) {
                    displayResults(data);
                } else {
                    console.error("API call succeeded but returned error:", data);
                    showError(data.error || 'Error analyzing image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'Error uploading image. Please try again.');
            })
            .finally(() => {
                hideLoading();
            });
        });
        
        // Camera functionality
        startCameraBtn.addEventListener('click', startCamera);
        captureImageBtn.addEventListener('click', captureImage);
        switchCameraBtn.addEventListener('click', switchCamera);
        analyzeCapture.addEventListener('click', analyzeCapturedImage);
        retakeImage.addEventListener('click', retakePicture);
        
        async function startCamera() {
            try {
                if (stream) {
                    stopCamera();
                }
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                
                captureImageBtn.disabled = false;
                switchCameraBtn.disabled = false;
                startCameraBtn.innerHTML = '<i class="fas fa-video-slash"></i> Stop Camera';
                startCameraBtn.classList.replace('btn-primary', 'btn-danger');
                
                // Change event handler
                startCameraBtn.removeEventListener('click', startCamera);
                startCameraBtn.addEventListener('click', stopCamera);
                
                // Update switch camera button text based on current mode
                switchCameraBtn.innerHTML = currentFacingMode === 'environment' 
                    ? '<i class="fas fa-sync-alt"></i> Switch to Front Camera' 
                    : '<i class="fas fa-sync-alt"></i> Switch to Back Camera';
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                showError('Could not access camera. Make sure it\'s connected and you\'ve given permission.');
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                stream = null;
            }
            
            captureImageBtn.disabled = true;
            switchCameraBtn.disabled = true;
            startCameraBtn.innerHTML = '<i class="fas fa-video"></i> Start Camera';
            startCameraBtn.classList.replace('btn-danger', 'btn-primary');
            
            // Change event handler back
            startCameraBtn.removeEventListener('click', stopCamera);
            startCameraBtn.addEventListener('click', startCamera);
        }
        
        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            // Update button text to indicate which camera will be activated next time
            switchCameraBtn.innerHTML = currentFacingMode === 'environment' 
                ? '<i class="fas fa-sync-alt"></i> Switch to Front Camera' 
                : '<i class="fas fa-sync-alt"></i> Switch to Back Camera';
            stopCamera();
            startCamera();
        }
        
        function captureImage() {
            if (!stream) return;
            
            const context = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            // Draw the video frame to the canvas
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL
            capturedImage = canvas.toDataURL('image/jpeg');
            
            // Display the captured image
            cameraResultPreview.innerHTML = `<img src="${capturedImage}" alt="Captured" 
                                             style="max-width: 300px; max-height: 300px; border-radius: 8px;">`;
            cameraPreviewContainer.style.display = 'block';
            
            // Hide the video preview temporarily
            videoElement.style.display = 'none';
        }
        
        function retakePicture() {
            capturedImage = null;
            cameraPreviewContainer.style.display = 'none';
            videoElement.style.display = 'block';
        }
        
        function analyzeCapturedImage() {
            if (!capturedImage) {
                showError('Please capture an image first');
                return;
            }
            
            showLoading();
            
            // Send image data as JSON
            fetch('/scan/camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: capturedImage
                })
            })
            .then(response => {
                console.log("Camera upload response status:", response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error("API error:", data);
                        throw new Error(data.error || 'Error analyzing image');
                    }).catch(err => {
                        console.error("JSON parse error:", err);
                        throw new Error('Error analyzing image: Invalid response format');
                    });
                }
                return response.json().catch(err => {
                    console.error("JSON parse error:", err);
                    throw new Error('Error analyzing image: Invalid response format');
                });
            })
            .then(data => {
                if (data.success) {
                    displayResults(data);
                    stopCamera();
                } else {
                    console.error("API call succeeded but returned error:", data);
                    showError(data.error || 'Error analyzing image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'Error analyzing image. Please try again.');
            })
            .finally(() => {
                hideLoading();
            });
        }
        
        // Results handling
        function displayResults(data) {
            console.log("Scan results data:", data);
            
            results.style.display = 'block';
            errorMessage.style.display = 'none';
            
            const prediction = data.top_prediction;
            console.log("Top prediction:", prediction);
            
            if (!prediction) {
                console.error("No prediction found in response");
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Could not identify the item. Please try again with a clearer image.';
                return;
            }
            
            try {
                // Parse the material type from the label
                const itemLabel = prediction.label.replace(/_/g, ' ');
                console.log("Item label:", itemLabel);
                let materialType = 'Unknown';
                
                if (itemLabel.includes('plastic')) {
                    materialType = 'Plastic';
                } else if (itemLabel.includes('glass')) {
                    materialType = 'Glass';
                } else if (itemLabel.includes('paper') || itemLabel.includes('cardboard')) {
                    materialType = 'Paper/Cardboard';
                } else if (itemLabel.includes('metal') || itemLabel.includes('aluminum') || itemLabel.includes('steel')) {
                    materialType = 'Metal';
                } else if (itemLabel.includes('organic') || itemLabel.includes('food')) {
                    materialType = 'Organic';
                } else if (itemLabel.includes('electronic') || itemLabel.includes('e_waste')) {
                    materialType = 'Electronic';
                } else if (itemLabel.includes('textile') || itemLabel.includes('clothing')) {
                    materialType = 'Textile';
                }
                
                console.log("Material type:", materialType);
                
                // Display top prediction and material type
                wasteType.textContent = itemLabel;
                confidence.textContent = `${Math.round(prediction.confidence * 100)}% confidence`;
                
                // Display what item was scanned
                document.getElementById('item-scanned').innerHTML = `<strong>Item Scanned:</strong> ${data.item_name || itemLabel}`;
                
                // Check for GPT-4o analysis results
                if (data.gpt_analysis) {
                    console.log("GPT analysis data:", data.gpt_analysis);
                    
                    // Get the analysis results container
                    let gptAnalysisContainer = document.getElementById('gpt-analysis-container');
                    
                    // If the container doesn't exist, create it
                    if (!gptAnalysisContainer) {
                        gptAnalysisContainer = document.createElement('div');
                        gptAnalysisContainer.id = 'gpt-analysis-container';
                        gptAnalysisContainer.className = 'gpt-analysis';
                        
                        // Insert it after the guidelines section
                        const guidelinesSection = document.querySelector('.guidelines');
                        if (guidelinesSection && guidelinesSection.nextElementSibling) {
                            results.insertBefore(gptAnalysisContainer, guidelinesSection.nextElementSibling);
                        } else {
                            // Append to results if guidelines section not found
                            results.appendChild(gptAnalysisContainer);
                        }
                    }
                    
                    // Determine badge class based on waste type
                    const wasteTypeBadgeClass = `badge-${data.gpt_analysis.waste_type || 'mixed'}`;
                    
                    // Create HTML content for GPT analysis
                    let gptAnalysisHtml = `
                        <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                        <div class="mb-3">
                            <span class="badge ${wasteTypeBadgeClass} p-2">
                                ${(data.gpt_analysis.waste_type || 'Unknown').toUpperCase()}
                            </span>
                        </div>
                    `;
                    
                    // Material Composition Section
                    if (data.gpt_analysis.material_composition && data.gpt_analysis.material_composition.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-atom"></i> Material Composition</h5>
                                <ul>
                                    ${data.gpt_analysis.material_composition.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Recyclability Section
                    if (data.gpt_analysis.recyclability && data.gpt_analysis.recyclability.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-recycle"></i> Recyclability</h5>
                                <ul>
                                    ${data.gpt_analysis.recyclability.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Disposal Suggestions Section
                    if (data.gpt_analysis.disposal_suggestions && data.gpt_analysis.disposal_suggestions.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-trash-alt"></i> Disposal Suggestions</h5>
                                <ul>
                                    ${data.gpt_analysis.disposal_suggestions.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Set the HTML content
                    gptAnalysisContainer.innerHTML = gptAnalysisHtml;
                }
                
                // Store scan_id and waste_type for confirmation
                let scan_id = data.scan_id || null;
                console.log("Scan ID:", scan_id);
                const wasteTypeValue = prediction.label;
                
                // Setup confirm disposal button
                confirmDisposal.onclick = function() {
                    confirmWasteDisposal(wasteTypeValue, scan_id);
                };
                
                // Fetch guidelines from API
                console.log("Fetching guidelines for waste type:", wasteTypeValue);
                fetch(`/api/guidelines/${wasteTypeValue}`)
                    .then(response => {
                        console.log("Guidelines response status:", response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Guidelines data:", data);
                        const guidelines = data.guidelines;
                        
                        let guidelinesHTML = '';
                        
                        if (guidelines) {
                            guidelinesHTML += `<div class="alert ${guidelines.recyclable ? 'alert-success' : 'alert-warning'}">
                                <strong>${guidelines.recyclable ? 'Recyclable' : 'Not Recyclable'}</strong>
                            </div>`;
                            
                            // Add material type information
                            guidelinesHTML += `<p><strong>Material:</strong> ${materialType}</p>`;
                            guidelinesHTML += `<p><strong>Preparation:</strong> ${guidelines.preparation}</p>`;
                            guidelinesHTML += `<p><strong>Bin:</strong> ${guidelines.bin_color}</p>`;
                            
                            if (guidelines.facts) {
                                guidelinesHTML += `<div class="alert alert-info mt-2">
                                    <i class="fas fa-info-circle"></i> <strong>Did you know?</strong> ${guidelines.facts}
                                </div>`;
                            }
                        } else {
                            guidelinesHTML = '<p>No specific guidelines available for this item.</p>';
                        }
                        
                        guidelinesContent.innerHTML = guidelinesHTML;
                        
                        // Also fetch nearby recycling centers
                        fetchRecyclingCenters(wasteTypeValue);
                    })
                    .catch(error => {
                        console.error('Error fetching guidelines:', error);
                        guidelinesContent.innerHTML = '<p>Error loading recycling guidelines.</p>';
                    });
            } catch (error) {
                console.error("Error displaying results:", error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error displaying results. Please try again.';
            }
        }
        
        function confirmWasteDisposal(wasteType, scan_id) {
            const requestBody = {
                waste_type: wasteType
            };
            
            // Add scan_id if available
            if (scan_id) {
                requestBody.scan_id = scan_id;
            }
            
            fetch('/api/confirm_disposal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Error confirming disposal');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const message = data.message || 'Disposal confirmed! Thank you for recycling responsibly.';
                    
                    // Create a success alert
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                    if (data.points_earned) {
                        alertDiv.innerHTML += ` You earned <strong>${data.points_earned} points</strong>!`;
                    }
                    
                    // Insert the alert at the top of the results
                    const resultsHeader = document.querySelector('.results-header');
                    if (resultsHeader && resultsHeader.nextElementSibling) {
                        results.insertBefore(alertDiv, resultsHeader.nextElementSibling);
                    } else {
                        guidelinesContent.prepend(alertDiv);
                    }
                    
                    // Disable the confirm button
                    confirmDisposal.disabled = true;
                    confirmDisposal.innerHTML = '<i class="fas fa-check"></i> Disposal Confirmed';
                } else {
                    showError(data.error || 'Error confirming disposal');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'Error confirming disposal. Please try again.');
            });
        }
        
        function fetchRecyclingCenters(wasteType) {
            // Show loading state for centers
            centersList.innerHTML = '<div class="text-center"><div class="spinner-border text-success" role="status"></div><p>Finding recycling centers...</p></div>';
            
            // Get user's location if available
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Success - user allowed location access
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Make API request with coordinates and waste type
                    fetch(`/api/recycling-centers?lat=${lat}&lon=${lon}&waste_type=${wasteType}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success && data.centers && data.centers.length > 0) {
                                displayRecyclingCenters(data.centers);
                            } else {
                                // Fall back to mock data if no results
                                displayMockRecyclingCenters();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching recycling centers:', error);
                            displayMockRecyclingCenters();
                        });
                },
                function(error) {
                    // Error or user denied location access - use mock data
                    console.warn('Geolocation error:', error);
                    displayMockRecyclingCenters();
                },
                {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }
        
        function displayRecyclingCenters(centers) {
            let centersHTML = '';
            
            if (centers && centers.length > 0) {
                centers.forEach(center => {
                    // Convert distance from km to miles if needed
                    let distanceText = center.distance;
                    if (typeof distanceText === 'number') {
                        // Convert to miles if it's in km (backend might not have converted)
                        const distanceInMiles = center.distance_unit === 'km' ? 
                            (center.distance * 0.621371).toFixed(1) : 
                            center.distance.toFixed(1);
                        distanceText = `${distanceInMiles} miles`;
                    }
                    
                    centersHTML += `<div class="center-card">
                        <h5>${center.name}</h5>
                        <p><i class="fas fa-map-marker-alt"></i> ${center.address} (${distanceText})</p>
                        <p><strong>Accepts:</strong> ${center.accepts.join(', ')}</p>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(center.address)}" 
                           target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-directions"></i> Get Directions
                        </a>
                    </div>`;
                });
            } else {
                centersHTML = '<p>No recycling centers found nearby.</p>';
            }
            
            centersList.innerHTML = centersHTML;
        }
        
        function displayMockRecyclingCenters() {
            const centers = [
                {
                    name: 'City Recycling Center',
                    address: '123 Green St, San Francisco',
                    distance: '1.2 miles',
                    accepts: ['plastic', 'paper', 'glass', 'metal']
                },
                {
                    name: 'EcoWaste Processing',
                    address: '456 Recycle Ave, San Francisco',
                    distance: '2.8 miles',
                    accepts: ['electronics', 'batteries', 'hazardous']
                },
                {
                    name: 'Green Future Recycling',
                    address: '789 Earth Blvd, San Francisco',
                    distance: '3.5 miles',
                    accepts: ['plastic', 'paper', 'glass', 'metal', 'compost']
                }
            ];
            
            let centersHTML = '';
            
            if (centers && centers.length > 0) {
                centers.forEach(center => {
                    centersHTML += `<div class="center-card">
                        <h5>${center.name}</h5>
                        <p><i class="fas fa-map-marker-alt"></i> ${center.address} (${center.distance})</p>
                        <p><strong>Accepts:</strong> ${center.accepts.join(', ')}</p>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(center.address)}" 
                           target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-directions"></i> Get Directions
                        </a>
                    </div>`;
                });
                
                centersHTML += `<div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> These are example recycling centers. 
                    <a href="/centers" class="alert-link">Find real centers near you</a>.
                </div>`;
            } else {
                centersHTML = `<p>No recycling centers found nearby. 
                              <a href="/centers">Search for centers</a> in your area.</p>`;
            }
            
            centersList.innerHTML = centersHTML;
        }
        
        // Helpers
        function showLoading() {
            loading.style.display = 'block';
            results.style.display = 'none';
            hideError();
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                hideError();
            }, 5000);
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Reset and scan again
        scanAnother.addEventListener('click', function() {
            results.style.display = 'none';
            preview.innerHTML = '';
            fileInput.value = '';
            uploadBtnContainer.style.display = 'none';
            
            // Reset camera tab if it was used
            if (cameraPreviewContainer.style.display !== 'none') {
                retakePicture();
            }
        });
        
        // Tab switching
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.id === 'camera-tab') {
                    // When switching to camera tab, stop any capture in progress
                    if (stream) {
                        stopCamera();
                    }
                }
            });
        });
    });
</script>
{% endblock %} 