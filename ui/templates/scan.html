{% extends "layout.html" %}

{% block title %}Scan Waste - RecycleRight{% endblock %}

{% block styles %}
<style>
    .scan-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .page-header {
        margin-bottom: 30px;
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .page-header h1 {
        font-size: 2.2rem;
        margin-bottom: 12px;
        color: #4CAF50;
        font-weight: 600;
    }
    
    .page-header p {
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto;
        opacity: 0.9;
        line-height: 1.5;
    }
    
    .nav-tabs {
        border-bottom: none;
        margin-bottom: 15px;
    }
    
    .nav-tabs .nav-link {
        border-radius: 8px 8px 0 0;
        background-color: rgba(255, 255, 255, 0.1);
        margin-right: 5px;
        transition: all 0.3s ease;
        font-size: 0.95rem;
        padding: 10px 20px;
        border: none;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #4CAF50;
        color: white;
        font-weight: 500;
    }
    
    .tab-content {
        padding: 25px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 0 8px 8px 8px;
        min-height: 400px;
    }
    
    #drop-area {
        border: 2px dashed rgba(132, 197, 171, 0.5);
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        margin: 0 auto 30px;
        background-color: rgba(132, 197, 171, 0.05);
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    #drop-area p {
        margin-bottom: 20px;
        color: #eee;
        font-size: 1.1rem;
    }
    
    #select-file-btn {
        padding: 14px 28px;
        font-size: 1.15rem;
        border-radius: 12px;
        background-color: #4CAF50;
        border-color: #4CAF50;
        transition: all 0.3s ease;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #select-file-btn:hover {
        background-color: #3d8b40;
        border-color: #3d8b40;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
    }
    
    #drop-area.highlight {
        border-color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.1);
    }
    
    #file-input {
        display: none;
    }
    
    #preview {
        margin: 30px auto;
        text-align: center;
        max-width: 400px;
    }
    
    #preview img {
        max-width: 100%;
        max-height: 350px;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        margin: 0 auto;
        display: block;
    }
    
    .camera-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    #camera-preview {
        width: 100%;
        max-width: 350px;
        height: auto;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    #camera-result-preview {
        margin: 10px auto;
        text-align: center;
    }
    
    #camera-result-preview img {
        max-width: 300px;
        max-height: 250px;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .camera-controls {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    
    .camera-controls button {
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .loading-container {
        display: none;
        text-align: center;
        margin: 20px auto;
        padding: 15px;
        max-width: 300px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        margin: 0 auto;
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #4CAF50;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .results-container {
        display: none;
        margin-top: 40px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .results-header {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .results-header i {
        font-size: 2rem;
        margin-right: 15px;
        color: #4CAF50;
    }
    
    .results-header h2 {
        font-size: 1.8rem;
        margin: 0;
        font-weight: 600;
    }
    
    .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    @media (min-width: 768px) {
        .results-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    .results-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .result-image {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .result-image img {
        max-width: 250px;
        max-height: 250px;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .waste-type {
        text-transform: capitalize;
        font-weight: bold;
        color: #4CAF50;
    }
    
    .confidence {
        color: #aaa;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    .guidelines {
        margin: 0;
        padding: 25px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .guidelines h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .guidelines h4 i {
        margin-right: 12px;
    }
    
    .alert {
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border: none;
    }
    
    .alert-success {
        background-color: rgba(76, 175, 80, 0.15);
        color: #e8f5e9;
    }
    
    .alert-warning {
        background-color: rgba(255, 152, 0, 0.15);
        color: #fff8e1;
    }
    
    .alert-info {
        background-color: rgba(33, 150, 243, 0.15);
        color: #e3f2fd;
    }
    
    .recycling-centers {
        margin: 0;
        padding: 25px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .recycling-centers h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .recycling-centers h4 i {
        margin-right: 12px;
    }
    
    .center-card {
        margin-bottom: 15px;
        padding: 18px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        transition: all 0.2s ease;
        border-left: 3px solid #4CAF50;
    }
    
    .center-card:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .center-card h5 {
        margin-top: 0;
        color: #4CAF50;
    }
    
    .btn-next {
        margin-top: 25px;
        text-align: center;
    }
    
    .btn-next button {
        margin: 0 5px 10px;
    }
    
    .error-message {
        color: #f44336;
        text-align: center;
        margin: 20px auto;
        padding: 12px;
        max-width: 500px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 8px;
        display: none;
    }
    
    /* GPT Analysis Section Styles */
    .gpt-analysis {
        margin: 0;
        padding: 25px;
        background-color: rgba(76, 175, 80, 0.08);
        border-radius: 12px;
        border-left: 4px solid #4CAF50;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .gpt-analysis h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .gpt-analysis h4 i {
        margin-right: 12px;
    }
    
    .gpt-analysis-section {
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
    }
    
    .gpt-analysis-section h5 {
        font-size: 1.1rem;
        color: #2E7D32;
        margin-bottom: 10px;
        border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        padding-bottom: 8px;
        font-weight: 600;
    }
    
    .gpt-analysis-section ul {
        padding-left: 20px;
        margin-bottom: 0;
    }
    
    .gpt-analysis-section li {
        margin-bottom: 5px;
    }
    
    /* Badge styles for waste type */
    .badge-recyclable {
        background-color: #4CAF50;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-compostable {
        background-color: #8BC34A;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-trash {
        background-color: #F44336;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-mixed {
        background-color: #FF9800;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    @media (max-width: 768px) {
        .scan-container {
            padding: 20px 15px;
            margin: 0 8px;
            border-radius: 12px;
        }
        
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .page-header p {
            font-size: 1rem;
            padding: 0 5px;
        }
        
        .tab-content {
            padding: 15px;
            min-height: auto;
        }
        
        #drop-area {
            padding: 20px 15px;
            margin-bottom: 20px;
        }
        
        #select-file-btn {
            width: 100%;
            padding: 12px 20px;
        }
        
        #preview img {
            max-height: 300px;
        }
        
        .results-container {
            padding: 20px 15px;
        }
        
        .results-grid {
            display: block;
        }
        
        .results-column {
            margin-bottom: 20px;
        }
        
        .result-image img {
            max-width: 100%;
            max-height: 250px;
        }
        
        .btn-next button {
            width: 100%;
            margin: 0 0 15px 0;
        }
    }
    
    .button-animation {
        transition: all 0.3s ease;
    }
    
    .button-animation:active {
        transform: scale(0.95);
    }
    
    .upload-icon-container {
        margin-bottom: 15px;
    }
    
    .upload-icon {
        font-size: 2.5rem;
        color: #4CAF50;
        margin-bottom: 10px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    .loading-container {
        display: none;
        text-align: center;
        margin: 20px auto;
        padding: 20px;
        max-width: 350px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        margin: 0 auto;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        border-top: 4px solid #4CAF50;
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="scan-container">
    <div class="page-header">
        <h1><i class="fas fa-camera"></i> Scan Your Waste</h1>
        <p>
            Take a photo or upload an image of your waste item for AI-powered classification 
            and get personalized recycling guidance.
        </p>
    </div>
    
    <ul class="nav nav-tabs" id="scanTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" 
                    type="button" role="tab" aria-controls="upload" aria-selected="true">
                <i class="fas fa-upload"></i> Upload Image
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" 
                    type="button" role="tab" aria-controls="camera" aria-selected="false">
                <i class="fas fa-camera"></i> Use Camera
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="scanTabContent">
        <!-- Upload Tab -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
            <form id="upload-form">
                <div id="drop-area">
                    <div class="upload-icon-container">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    </div>
                    <p>Take a photo of your waste item for analysis</p>
                    <input type="file" id="file-input" accept="image/*" capture="environment">
                    <button type="button" class="btn btn-primary mt-2 button-animation" id="select-file-btn">
                        <i class="fas fa-camera"></i> Upload Image
                    </button>
                </div>
                
                <div id="preview"></div>
            </form>
        </div>
        
        <!-- Camera Tab -->
        <div class="tab-pane fade" id="camera" role="tabpanel" aria-labelledby="camera-tab">
            <div class="camera-container">
                <video id="camera-preview" autoplay playsinline></video>
                
                <div class="camera-controls">
                    <button class="btn btn-primary" id="start-camera">
                        <i class="fas fa-video"></i> Start Camera
                    </button>
                    
                    <button class="btn btn-success" id="capture-image" disabled>
                        <i class="fas fa-camera"></i> Capture Image
                    </button>
                    
                    <button class="btn btn-secondary" id="switch-camera" disabled>
                        <i class="fas fa-sync-alt"></i> Switch Camera
                    </button>
                </div>
                
                <div id="camera-preview-container" class="mt-3" style="display: none;">
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div id="camera-result-preview"></div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success" id="analyze-capture">
                            <i class="fas fa-search"></i> Analyze Image
                        </button>
                        <button class="btn btn-secondary" id="retake-image">
                            <i class="fas fa-redo"></i> Retake
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-container" id="loading">
        <div class="spinner"></div>
        <p class="mt-3">Analyzing your waste item...</p>
        <p class="text-muted small">This may take a few moments</p>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="error-message"></div>
    
    <!-- Results -->
    <div class="results-container" id="results">
        <div class="results-header">
            <i class="fas fa-recycle"></i>
            <h2>Analysis Results</h2>
        </div>
        
        <div class="results-grid">
            <div class="results-column">
                <div class="result-image" id="result-image-container">
                    <!-- Result image will be placed here -->
                </div>
                
                <div class="alert alert-success">
                    <p class="mb-1">This item is a <span class="waste-type" id="waste-type"></span> 
                       <span class="confidence" id="confidence"></span></p>
                    <p class="mb-0" id="item-scanned"></p>
                </div>
                
                <div class="guidelines">
                    <h4><i class="fas fa-info-circle"></i> Recycling Guidelines</h4>
                    <div id="guidelines-content"></div>
                </div>
            </div>
            
            <div class="results-column">
                <div id="gpt-analysis-container" class="gpt-analysis">
                    <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                    <p class="text-muted">Advanced analysis will appear here after scanning</p>
                </div>
                
                <div class="recycling-centers">
                    <h4><i class="fas fa-map-marker-alt"></i> Nearby Recycling Centers</h4>
                    <div id="centers-list"></div>
                </div>
            </div>
        </div>
        
        <div class="btn-next">
            <button class="btn btn-success btn-lg me-3 button-animation" id="confirm-disposal">
                <i class="fas fa-check-circle"></i> Confirm Proper Disposal
            </button>
            <button class="btn btn-primary btn-lg button-animation" id="scan-another">
                <i class="fas fa-redo"></i> Scan Another Item
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const preview = document.getElementById('preview');
        const uploadForm = document.getElementById('upload-form');
        const uploadBtnContainer = document.getElementById('upload-btn-container');
        
        const startCameraBtn = document.getElementById('start-camera');
        const captureImageBtn = document.getElementById('capture-image');
        const switchCameraBtn = document.getElementById('switch-camera');
        const videoElement = document.getElementById('camera-preview');
        const canvas = document.getElementById('canvas');
        const cameraResultPreview = document.getElementById('camera-result-preview');
        const cameraPreviewContainer = document.getElementById('camera-preview-container');
        const analyzeCapture = document.getElementById('analyze-capture');
        const retakeImage = document.getElementById('retake-image');
        
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        
        const wasteType = document.getElementById('waste-type');
        const confidence = document.getElementById('confidence');
        const guidelinesContent = document.getElementById('guidelines-content');
        const centersList = document.getElementById('centers-list');
        
        const confirmDisposal = document.getElementById('confirm-disposal');
        const scanAnother = document.getElementById('scan-another');
        
        let capturedImage = null;
        let stream = null;
        let currentFacingMode = 'environment'; // 'environment' for back camera, 'user' for front
        
        // File Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].type.match('image.*')) {
                handleFiles(files);
            } else {
                showError('Please upload an image file (JPEG, PNG, etc.)');
            }
        }
        
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
            }
        });
        
        function handleFiles(files) {
            const file = files[0];
            if (file.type.match('image.*')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    // Analyze the image automatically after upload
                    analyzeImage(file);
                };
                
                reader.readAsDataURL(file);
            } else {
                showError('Please select an image file (JPEG, PNG, etc.)');
                fileInput.value = '';
                preview.innerHTML = '';
            }
        }
        
        // Form submission is now handled by the analyzeImage function
        function analyzeImage(file) {
            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/scan/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log("Upload response status:", response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error("API error:", data);
                        throw new Error(data.error || 'Error analyzing image');
                    }).catch(err => {
                        console.error("JSON parse error:", err);
                        throw new Error('Error analyzing image: Invalid response format');
                    });
                }
                return response.json().catch(err => {
                    console.error("JSON parse error:", err);
                    throw new Error('Error analyzing image: Invalid response format');
                });
            })
            .then(data => {
                if (data.success) {
                    displayResults(data);
                } else {
                    console.error("API call succeeded but returned error:", data);
                    showError(data.error || 'Error analyzing image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'Error uploading image. Please try again.');
            })
            .finally(() => {
                hideLoading();
            });
        }
        
        // Camera functionality
        startCameraBtn.addEventListener('click', startCamera);
        captureImageBtn.addEventListener('click', captureImage);
        switchCameraBtn.addEventListener('click', switchCamera);
        analyzeCapture.addEventListener('click', analyzeCapturedImage);
        retakeImage.addEventListener('click', retakePicture);
        
        async function startCamera() {
            try {
                if (stream) {
                    stopCamera();
                }
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = stream;
                
                captureImageBtn.disabled = false;
                switchCameraBtn.disabled = false;
                startCameraBtn.innerHTML = '<i class="fas fa-video-slash"></i> Stop Camera';
                startCameraBtn.classList.replace('btn-primary', 'btn-danger');
                
                // Change event handler
                startCameraBtn.removeEventListener('click', startCamera);
                startCameraBtn.addEventListener('click', stopCamera);
                
                // Update switch camera button text based on current mode
                switchCameraBtn.innerHTML = currentFacingMode === 'environment' 
                    ? '<i class="fas fa-sync-alt"></i> Switch to Front Camera' 
                    : '<i class="fas fa-sync-alt"></i> Switch to Back Camera';
                
            } catch (err) {
                console.error('Error accessing camera:', err);
                showError('Could not access camera. Make sure it\'s connected and you\'ve given permission.');
            }
        }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoElement.srcObject = null;
                stream = null;
            }
            
            captureImageBtn.disabled = true;
            switchCameraBtn.disabled = true;
            startCameraBtn.innerHTML = '<i class="fas fa-video"></i> Start Camera';
            startCameraBtn.classList.replace('btn-danger', 'btn-primary');
            
            // Change event handler back
            startCameraBtn.removeEventListener('click', stopCamera);
            startCameraBtn.addEventListener('click', startCamera);
        }
        
        function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            // Update button text to indicate which camera will be activated next time
            switchCameraBtn.innerHTML = currentFacingMode === 'environment' 
                ? '<i class="fas fa-sync-alt"></i> Switch to Front Camera' 
                : '<i class="fas fa-sync-alt"></i> Switch to Back Camera';
            stopCamera();
            startCamera();
        }
        
        function captureImage() {
            if (!stream) return;
            
            const context = canvas.getContext('2d');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            // Draw the video frame to the canvas
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL
            capturedImage = canvas.toDataURL('image/jpeg');
            
            // Display the captured image
            cameraResultPreview.innerHTML = `<img src="${capturedImage}" alt="Captured" 
                                             style="max-width: 300px; max-height: 300px; border-radius: 8px;">`;
            cameraPreviewContainer.style.display = 'block';
            
            // Hide the video preview temporarily
            videoElement.style.display = 'none';
        }
        
        function retakePicture() {
            capturedImage = null;
            cameraPreviewContainer.style.display = 'none';
            videoElement.style.display = 'block';
        }
        
        function analyzeCapturedImage() {
            if (!capturedImage) {
                showError('Please capture an image first');
                return;
            }
            
            showLoading();
            
            // Send image data as JSON
            fetch('/scan/camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image: capturedImage
                })
            })
            .then(response => {
                console.log("Camera upload response status:", response.status);
                if (!response.ok) {
                    return response.json().then(data => {
                        console.error("API error:", data);
                        throw new Error(data.error || 'Error analyzing image');
                    }).catch(err => {
                        console.error("JSON parse error:", err);
                        throw new Error('Error analyzing image: Invalid response format');
                    });
                }
                return response.json().catch(err => {
                    console.error("JSON parse error:", err);
                    throw new Error('Error analyzing image: Invalid response format');
                });
            })
            .then(data => {
                if (data.success) {
                    displayResults(data);
                    stopCamera();
                } else {
                    console.error("API call succeeded but returned error:", data);
                    showError(data.error || 'Error analyzing image');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message || 'Error analyzing image. Please try again.');
            })
            .finally(() => {
                hideLoading();
            });
        }
        
        // Results handling
        function displayResults(data) {
            console.log("Scan results data:", data);
            
            results.style.display = 'block';
            errorMessage.style.display = 'none';
            
            const prediction = data.top_prediction;
            console.log("Top prediction:", prediction);
            
            if (!prediction) {
                console.error("No prediction found in response");
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Could not identify the item. Please try again with a clearer image.';
                return;
            }
            
            try {
                // Display the image in results
                const resultImageContainer = document.getElementById('result-image-container');
                let imageSrc = '';
                
                // Get the image source from either the file path or the captured image
                if (data.file_path) {
                    // Convert server filepath to web URL by replacing any upload folder path
                    imageSrc = data.file_path.replace(/^.*uploads/, '/static/uploads');
                } else if (capturedImage) {
                    imageSrc = capturedImage;
                }
                
                if (imageSrc) {
                    resultImageContainer.innerHTML = `<img src="${imageSrc}" alt="Analyzed Waste Item">`;
                }
                
                // Parse the material type from the label
                const itemLabel = prediction.label.replace(/_/g, ' ');
                console.log("Item label:", itemLabel);
                let materialType = 'Unknown';
                
                if (itemLabel.includes('plastic')) {
                    materialType = 'Plastic';
                } else if (itemLabel.includes('glass')) {
                    materialType = 'Glass';
                } else if (itemLabel.includes('paper') || itemLabel.includes('cardboard')) {
                    materialType = 'Paper/Cardboard';
                } else if (itemLabel.includes('metal') || itemLabel.includes('aluminum') || itemLabel.includes('steel')) {
                    materialType = 'Metal';
                } else if (itemLabel.includes('organic') || itemLabel.includes('food')) {
                    materialType = 'Organic';
                } else if (itemLabel.includes('electronic') || itemLabel.includes('e_waste')) {
                    materialType = 'Electronic';
                } else if (itemLabel.includes('textile') || itemLabel.includes('clothing')) {
                    materialType = 'Textile';
                }
                
                console.log("Material type:", materialType);
                
                // Display top prediction and material type
                wasteType.textContent = itemLabel;
                confidence.textContent = `${Math.round(prediction.confidence * 100)}% confidence`;
                
                // Display what item was scanned
                document.getElementById('item-scanned').innerHTML = `<strong>Item Scanned:</strong> ${data.item_name || itemLabel}`;
                
                // Check for GPT-4o analysis results
                const gptAnalysisContainer = document.getElementById('gpt-analysis-container');
                
                if (data.gpt_analysis && 
                   (data.gpt_analysis.material_composition?.length > 0 || 
                    data.gpt_analysis.recyclability?.length > 0 || 
                    data.gpt_analysis.disposal_suggestions?.length > 0)) {
                    
                    console.log("GPT analysis data:", data.gpt_analysis);
                    
                    // Determine badge class based on waste type
                    const wasteTypeBadgeClass = `badge-${data.gpt_analysis.waste_type || 'mixed'}`;
                    
                    // Create HTML content for GPT analysis
                    let gptAnalysisHtml = `
                        <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                        <div class="mb-3">
                            <span class="badge ${wasteTypeBadgeClass} p-2">
                                ${(data.gpt_analysis.waste_type || 'Unknown').toUpperCase()}
                            </span>
                        </div>
                    `;
                    
                    // Material Composition Section
                    if (data.gpt_analysis.material_composition && data.gpt_analysis.material_composition.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-atom"></i> Material Composition</h5>
                                <ul>
                                    ${data.gpt_analysis.material_composition.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Recyclability Section
                    if (data.gpt_analysis.recyclability && data.gpt_analysis.recyclability.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-recycle"></i> Recyclability</h5>
                                <ul>
                                    ${data.gpt_analysis.recyclability.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Disposal Suggestions Section
                    if (data.gpt_analysis.disposal_suggestions && data.gpt_analysis.disposal_suggestions.length > 0) {
                        gptAnalysisHtml += `
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-trash-alt"></i> Disposal Suggestions</h5>
                                <ul>
                                    ${data.gpt_analysis.disposal_suggestions.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Set the HTML content
                    gptAnalysisContainer.innerHTML = gptAnalysisHtml;
                } else {
                    // If no GPT analysis, display a standard analysis based on the waste type
                    let analysisMessage = "";
                    
                    if (materialType === 'Plastic') {
                        analysisMessage = "Plastic items should be clean and dry before recycling. Remove any non-plastic components.";
                    } else if (materialType === 'Glass') {
                        analysisMessage = "Glass is 100% recyclable and can be recycled endlessly without loss in quality.";
                    } else if (materialType === 'Paper/Cardboard') {
                        analysisMessage = "Paper products should be clean and free of food residue. Flatten cardboard boxes to save space.";
                    } else if (materialType === 'Metal') {
                        analysisMessage = "Metal items are highly recyclable. Ensure they are clean and free of food residue.";
                    } else if (materialType === 'Organic') {
                        analysisMessage = "Organic waste can be composted to create nutrient-rich soil for gardening.";
                    } else if (materialType === 'Electronic') {
                        analysisMessage = "Electronic waste contains hazardous materials and should be taken to specialized e-waste recycling centers.";
                    } else {
                        analysisMessage = "Follow local recycling guidelines for proper disposal of this item.";
                    }
                    
                    const recyclabilityGuide = itemLabel.includes('plastic') ? 
                        "Check the recycling number on the bottom of the item. Numbers 1 (PET) and 2 (HDPE) are widely accepted." : 
                        "This item should be disposed of according to local recycling guidelines.";
                    
                    gptAnalysisContainer.innerHTML = `
                        <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                        <div class="gpt-analysis-section">
                            <h5><i class="fas fa-atom"></i> Material Composition</h5>
                            <p>This item appears to be made primarily of ${materialType.toLowerCase()}.</p>
                        </div>
                        <div class="gpt-analysis-section">
                            <h5><i class="fas fa-recycle"></i> Recyclability</h5>
                            <p>${analysisMessage}</p>
                        </div>
                        <div class="gpt-analysis-section">
                            <h5><i class="fas fa-trash-alt"></i> Disposal Suggestions</h5>
                            <p>${recyclabilityGuide}</p>
                        </div>
                    `;
                }
                
                // Store scan_id and waste_type for confirmation
                let scan_id = data.scan_id || null;
                console.log("Scan ID:", scan_id);
                const wasteTypeValue = prediction.label;
                
                // Setup confirm disposal button
                confirmDisposal.onclick = function() {
                    confirmWasteDisposal(wasteTypeValue, scan_id);
                };
                
                // Fetch guidelines from API
                console.log("Fetching guidelines for waste type:", wasteTypeValue);
                fetch(`/api/guidelines/${wasteTypeValue}`)
                    .then(response => {
                        console.log("Guidelines response status:", response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Guidelines data:", data);
                        const guidelines = data.guidelines;
                        
                        let guidelinesHTML = '';
                        
                        if (guidelines) {
                            guidelinesHTML += `<div class="alert ${guidelines.recyclable ? 'alert-success' : 'alert-warning'}">
                                <strong>${guidelines.recyclable ? 'Recyclable ♻️' : 'Not Recyclable ⚠️'}</strong>
                            </div>`;
                            
                            // Add material type information
                            guidelinesHTML += `<p><strong>Material:</strong> ${materialType}</p>`;
                            guidelinesHTML += `<p><strong>Preparation:</strong> ${guidelines.preparation}</p>`;
                            guidelinesHTML += `<p><strong>Bin:</strong> <span class="badge bg-${guidelines.bin_color === 'blue' ? 'primary' : guidelines.bin_color === 'green' ? 'success' : guidelines.bin_color === 'black' ? 'dark' : 'secondary'} p-2">${guidelines.bin_color.toUpperCase()} BIN</span></p>`;
                            
                            if (guidelines.facts) {
                                guidelinesHTML += `<div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-2"></i> <strong>Did you know?</strong> ${guidelines.facts}
                                </div>`;
                            }
                        } else {
                            guidelinesHTML = '<p>No specific guidelines available for this item.</p>';
                        }
                        
                        guidelinesContent.innerHTML = guidelinesHTML;
                        
                        // Also fetch nearby recycling centers
                        fetchRecyclingCenters(wasteTypeValue);
                    })
                    .catch(error => {
                        console.error('Error fetching guidelines:', error);
                        guidelinesContent.innerHTML = '<p>Error loading recycling guidelines.</p>';
                    });
            } catch (error) {
                console.error("Error displaying results:", error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error displaying results. Please try again.';
            }
        }
        
        function confirmWasteDisposal(wasteType, scan_id) {
            // Show button loading state
            const originalText = confirmDisposal.innerHTML;
            confirmDisposal.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Confirming...';
            confirmDisposal.disabled = true;
            
            fetch('/api/confirm_disposal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    waste_type: wasteType,
                    scan_id: scan_id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    confirmDisposal.innerHTML = '<i class="fas fa-check"></i> Confirmed!';
                    confirmDisposal.classList.remove('btn-success');
                    confirmDisposal.classList.add('btn-outline-success');
                    
                    // Show congratulations message
                    if (data.points_earned > 0) {
                        const pointsMessage = `
                            <div class="alert alert-success mt-3 text-center animated fadeIn">
                                <i class="fas fa-trophy me-2"></i>
                                <strong>Congratulations!</strong> You earned ${data.points_earned} points for proper disposal.
                            </div>
                        `;
                        document.querySelector('.btn-next').insertAdjacentHTML('beforebegin', pointsMessage);
                    }
                    
                    // Disable confirm button
                    confirmDisposal.disabled = true;
                } else {
                    throw new Error(data.error || 'Error confirming disposal');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                confirmDisposal.innerHTML = originalText;
                confirmDisposal.disabled = false;
                
                // Show error message
                errorMessage.style.display = 'block';
                errorMessage.textContent = error.message || 'Error confirming disposal. Please try again.';
            });
        }
        
        function fetchRecyclingCenters(wasteType) {
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        console.log("Getting recycling centers near: ", lat, lon);
                        
                        fetch(`/api/recycling-centers?lat=${lat}&lon=${lon}&waste_type=${wasteType}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log("Recycling centers data:", data);
                                displayRecyclingCenters(data.centers || []);
                            })
                            .catch(error => {
                                console.error('Error fetching recycling centers:', error);
                                displayRecyclingCenters([]);
                            });
                    },
                    // Error callback
                    function(error) {
                        console.error("Geolocation error:", error);
                        displayDefaultRecyclingCenters();
                    }
                );
            } else {
                console.error("Geolocation not supported");
                displayDefaultRecyclingCenters();
            }
        }
        
        function displayRecyclingCenters(centers) {
            const centersList = document.getElementById('centers-list');
            
            if (!centers || centers.length === 0) {
                centersList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No recycling centers found nearby.
                        <p class="mt-2 mb-0">Try visiting our <a href="/centers" class="alert-link">Recycling Centers page</a> to search for locations in your area.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Display up to 3 centers
            centers.slice(0, 3).forEach(center => {
                const distance = center.distance ? 
                    `${center.distance.toFixed(1)} miles away` : 
                    '';
                    
                const address = center.address ? 
                    `<p class="mb-1"><i class="fas fa-map-marker-alt text-muted me-2"></i>${center.address}</p>` : 
                    '';
                    
                const phone = center.phone ? 
                    `<p class="mb-1"><i class="fas fa-phone text-muted me-2"></i>${center.phone}</p>` : 
                    '';
                    
                const website = center.website ? 
                    `<p class="mb-0"><i class="fas fa-globe text-muted me-2"></i><a href="${center.website}" target="_blank" rel="noopener">Website</a></p>` : 
                    '';
                    
                html += `
                    <div class="center-card">
                        <h5>${center.name || 'Recycling Center'}</h5>
                        ${distance ? `<p class="text-muted mb-2">${distance}</p>` : ''}
                        ${address}
                        ${phone}
                        ${website}
                    </div>
                `;
            });
            
            html += `
                <div class="text-center mt-3">
                    <a href="/centers" class="btn btn-outline-success">
                        <i class="fas fa-search-location"></i> Find More Centers
                    </a>
                </div>
            `;
            
            centersList.innerHTML = html;
        }
        
        function displayDefaultRecyclingCenters() {
            const centersList = document.getElementById('centers-list');
            
            centersList.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Enable location services to find recycling centers near you.
                    <p class="mt-2 mb-0">Or visit our <a href="/centers" class="alert-link">Recycling Centers page</a> to search for locations in your area.</p>
                </div>
            `;
        }
        
        // Helpers
        function showLoading() {
            loading.style.display = 'block';
            results.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Disable scan buttons to prevent multiple submissions
            const uploadBtn = document.querySelector('#upload-form button[type="submit"]');
            const analyzeBtn = document.getElementById('analyze-capture');
            
            if (uploadBtn) uploadBtn.disabled = true;
            if (analyzeBtn) analyzeBtn.disabled = true;
        }
        
        function hideLoading() {
            loading.style.display = 'none';
            
            // Re-enable scan buttons
            const uploadBtn = document.querySelector('#upload-form button[type="submit"]');
            const analyzeBtn = document.getElementById('analyze-capture');
            
            if (uploadBtn) uploadBtn.disabled = false;
            if (analyzeBtn) analyzeBtn.disabled = false;
        }
        
        function showError(message) {
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
            
            // Automatically hide after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
            
            // Scroll to error message
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Reset and scan again
        scanAnother.addEventListener('click', function() {
            // Hide results and clear preview
            results.style.display = 'none';
            preview.innerHTML = '';
            fileInput.value = '';
            
            // Reset camera if needed
            if (capturedImage) {
                capturedImage = null;
                cameraPreviewContainer.style.display = 'none';
            }
            
            // Reset tabs to upload tab
            document.getElementById('upload-tab').click();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Tab switching
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.id === 'camera-tab') {
                    // When switching to camera tab, stop any capture in progress
                    if (stream) {
                        stopCamera();
                    }
                }
            });
        });
    });
</script>
{% endblock %} 