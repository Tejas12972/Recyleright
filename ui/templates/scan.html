{% extends "layout.html" %}

{% block title %}Scan Waste - RecycleRight{% endblock %}

{% block styles %}
<style>
    .scan-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .page-header {
        margin-bottom: 30px;
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .page-header h1 {
        font-size: 2.4rem;
        margin-bottom: 16px;
        color: #5CDB95;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .page-header p {
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
        opacity: 1;
        line-height: 1.6;
        color: #f1f1f1;
    }
    
    .nav-tabs {
        border-bottom: none;
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.1);
        margin-right: 8px;
        transition: all 0.3s ease;
        font-size: 1rem;
        padding: 12px 22px;
        border: none;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #5CDB95;
        color: #11222a;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .tab-content {
        padding: 30px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        min-height: 400px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    
    /* Improved Drop Area */
    #drop-area {
        border: 2px dashed rgba(92, 219, 149, 0.4);
        border-radius: 20px;
        padding: 40px 30px;
        text-align: center;
        transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        margin: 0 auto 35px;
        background-color: rgba(92, 219, 149, 0.03);
        max-width: 500px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }

    #drop-area:hover {
        border-color: #5CDB95;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        background-color: rgba(92, 219, 149, 0.05);
    }

    #drop-area:after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(92, 219, 149, 0.1) 0%, rgba(92, 219, 149, 0) 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    #drop-area:hover:after {
        opacity: 1;
    }

    #drop-area p {
        margin-bottom: 24px;
        color: #f1f1f1;
        font-size: 1.15rem;
        font-weight: 300;
    }

    #drop-area .upload-icon-container {
        margin-bottom: 22px;
        position: relative;
    }

    #drop-area .upload-icon {
        font-size: 3.5rem;
        color: #5CDB95;
        margin-bottom: 15px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        transition: all 0.5s ease;
    }

    #drop-area:hover .upload-icon {
        transform: translateY(-5px);
    }

    /* Pulsing animation for upload icon */
    @keyframes gentle-pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.9;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    #drop-area .upload-icon {
        animation: gentle-pulse 3s infinite;
    }

    /* Upload button improvements */
    #select-file-btn {
        padding: 16px 32px;
        font-size: 1.1rem;
        border-radius: 50px;
        background: linear-gradient(135deg, #5CDB95 0%, #48bb7e 100%);
        border: none;
        color: #11222a;
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(92, 219, 149, 0.3);
        position: relative;
        overflow: hidden;
    }

    #select-file-btn:after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: all 0.6s ease;
    }

    #select-file-btn:hover {
        background: linear-gradient(135deg, #5CDB95 0%, #3da76c 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(92, 219, 149, 0.4);
    }

    #select-file-btn:hover:after {
        left: 100%;
    }

    #drop-area.highlight {
        border-color: #5CDB95;
        background-color: rgba(92, 219, 149, 0.1);
        transform: scale(1.02);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    /* Upload instructions improvements */
    .upload-instructions {
        margin-top: 10px;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    .supported-formats {
        display: inline-block;
        margin-top: 10px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.5);
        background-color: rgba(255, 255, 255, 0.05);
        padding: 4px 10px;
        border-radius: 20px;
    }

    /* Improved Preview Container */
    #preview {
        margin: 30px auto;
        text-align: center;
        max-width: 500px;
        position: relative;
        transition: all 0.3s ease;
    }

    /* Image Preview Wrapper */
    .image-preview-wrapper {
        position: relative;
        width: 100%;
        padding-top: 75%; /* 4:3 Aspect Ratio */
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        border: 1px solid rgba(92, 219, 149, 0.3);
        transition: all 0.3s ease;
    }

    /* Image Preview Container */
    .image-preview-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        backdrop-filter: blur(4px);
        background-color: rgba(17, 34, 42, 0.4);
    }

    /* Image Preview Styling */
    #preview img {
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    /* Image Info Bar */
    .image-info-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(17, 34, 42, 0.7);
        padding: 10px 15px;
        color: #fff;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(5px);
        opacity: 0;
        transform: translateY(100%);
        transition: all 0.3s ease;
    }

    .image-preview-wrapper:hover .image-info-bar {
        opacity: 1;
        transform: translateY(0);
    }

    .image-info-bar .file-name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 70%;
    }

    .image-info-bar .file-size {
        font-weight: 500;
        color: #5CDB95;
    }

    /* Success Indicator */
    .upload-success-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        background-color: rgba(92, 219, 149, 0.9);
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transform: scale(0);
        animation: popup 0.5s forwards;
    }

    @keyframes popup {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    /* Image Preview Actions */
    .image-preview-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }

    .image-preview-actions button {
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .image-preview-actions button i {
        margin-right: 8px;
    }

    .image-preview-actions .remove-image-btn {
        background-color: rgba(255, 255, 255, 0.1);
        color: #f1f1f1;
        border: none;
    }

    .image-preview-actions .remove-image-btn:hover {
        background-color: rgba(244, 67, 54, 0.2);
        color: #f44336;
    }

    /* Analyze Button Improvements */
    #analyze-btn-container {
        margin: 25px auto;
        text-align: center;
        max-width: 500px;
        display: none;
        transform: translateY(10px);
        animation: slide-up 0.5s forwards;
    }

    @keyframes slide-up {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
    }

    #analyze-btn {
        padding: 15px 32px;
        font-size: 1.2rem;
        border-radius: 50px;
        background: linear-gradient(135deg, #5CDB95 0%, #4bc080 100%);
        border: none;
        color: #11222a;
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(92, 219, 149, 0.4);
        width: 100%;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    #analyze-btn:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: all 0.6s ease;
        z-index: -1;
    }

    #analyze-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(92, 219, 149, 0.5);
    }

    #analyze-btn:hover:before {
        left: 100%;
    }

    /* Dark Mode Adjustments */
    @media (prefers-color-scheme: dark) {
        .image-preview-wrapper {
            background-color: rgba(255, 255, 255, 0.03);
            border-color: rgba(92, 219, 149, 0.2);
        }
    }

    /* Mobile Adjustments */
    @media (max-width: 768px) {
        #drop-area {
            padding: 30px 20px;
        }
        
        #drop-area .upload-icon {
            font-size: 2.8rem;
        }
        
        #drop-area p {
            font-size: 1.05rem;
            margin-bottom: 20px;
        }
        
        #select-file-btn {
            padding: 14px 28px;
            font-size: 1rem;
        }

        #preview {
            max-width: 100%;
        }
        
        .image-preview-wrapper {
            padding-top: 80%; /* Slightly taller on mobile */
        }
    }
    
    .loading-container {
        display: none;
        text-align: center;
        margin: 30px auto;
        padding: 30px;
        max-width: 400px;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        color: white;
    }
    
    .spinner {
        width: 70px;
        height: 70px;
        margin: 0 auto 20px;
        border: 6px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top: 6px solid #5CDB95;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .results-container {
        display: none;
        margin-top: 40px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 35px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .results-header {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .results-header i {
        font-size: 2.2rem;
        margin-right: 16px;
        color: #5CDB95;
    }
    
    .results-header h2 {
        font-size: 2rem;
        margin: 0;
        font-weight: 700;
        color: #f1f1f1;
    }
    
    .results-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    @media (min-width: 768px) {
        .results-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    .results-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .result-image {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .result-image img {
        max-width: 150px;
        max-height: 150px;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        margin: 0 auto;
        display: block;
    }
    
    .waste-type {
        text-transform: capitalize;
        font-weight: bold;
        color: #4CAF50;
    }
    
    .confidence {
        color: #aaa;
        font-size: 0.9rem;
        margin-left: 10px;
    }
    
    .guidelines {
        margin: 0;
        padding: 25px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .guidelines h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .guidelines h4 i {
        margin-right: 12px;
    }
    
    .alert {
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        border: none;
    }
    
    .alert-success {
        background-color: rgba(76, 175, 80, 0.15);
        color: #e8f5e9;
    }
    
    .alert-warning {
        background-color: rgba(255, 152, 0, 0.15);
        color: #fff8e1;
    }
    
    .alert-info {
        background-color: rgba(33, 150, 243, 0.15);
        color: #e3f2fd;
    }
    
    .recycling-centers {
        margin: 0;
        padding: 25px;
        background-color: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .recycling-centers h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .recycling-centers h4 i {
        margin-right: 12px;
    }
    
    .center-card {
        margin-bottom: 15px;
        padding: 18px;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        transition: all 0.2s ease;
        border-left: 3px solid #4CAF50;
    }
    
    .center-card:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .center-card h5 {
        margin-top: 0;
        color: #4CAF50;
    }
    
    .btn-next {
        margin-top: 30px;
        text-align: center;
    }
    
    .btn-next button {
        padding: 14px 32px;
        font-size: 1.2rem;
        border-radius: 50px;
        background-color: #5CDB95;
        border: none;
        color: #11222a;
        transition: all 0.3s ease;
        font-weight: 600;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-next button:hover {
        background-color: #4bc080;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .error-message {
        color: #f44336;
        text-align: center;
        margin: 20px auto;
        padding: 12px;
        max-width: 500px;
        background-color: rgba(244, 67, 54, 0.1);
        border-radius: 8px;
        display: none;
    }
    
    /* GPT Analysis Section Styles */
    .gpt-analysis {
        margin: 0;
        padding: 25px;
        background-color: rgba(76, 175, 80, 0.08);
        border-radius: 12px;
        border-left: 4px solid #4CAF50;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .gpt-analysis h4 {
        color: #4CAF50;
        margin-top: 0;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .gpt-analysis h4 i {
        margin-right: 12px;
    }
    
    .gpt-analysis-section {
        margin-bottom: 20px;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .gpt-analysis-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        background-color: rgba(255, 255, 255, 0.08);
    }
    
    .gpt-analysis-section h5 {
        font-size: 1.1rem;
        color: #2E7D32;
        margin-bottom: 12px;
        border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        padding-bottom: 8px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .gpt-analysis-section h5 i {
        margin-right: 8px;
    }
    
    .gpt-analysis-section ul {
        padding-left: 20px;
        margin-bottom: 0;
    }
    
    .gpt-analysis-section li {
        margin-bottom: 8px;
        line-height: 1.4;
        position: relative;
        padding-left: 5px;
    }
    
    .gpt-analysis-section li:last-child {
        margin-bottom: 0;
    }
    
    .gpt-analysis-section p {
        margin-bottom: 0;
        line-height: 1.5;
    }
    
    /* Badge styles for waste type */
    .badge-recyclable {
        background-color: #4CAF50;
        color: #11222a;
        font-weight: 700;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-compostable {
        background-color: #8BC34A;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-trash {
        background-color: #F44336;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .badge-mixed {
        background-color: #FF9800;
        color: #11222a;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    
    .button-animation {
        transition: all 0.3s ease;
    }
    
    .button-animation:active {
        transform: scale(0.95);
    }
    
    .upload-icon-container {
        margin-bottom: 18px;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #5CDB95;
        margin-bottom: 15px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="scan-container">
    <div class="page-header">
        <h1><i class="fas fa-camera"></i> Scan Your Waste</h1>
        <p>
            Upload an image of your waste item for AI-powered classification 
            and get personalized recycling guidance.
        </p>
    </div>
    
    <div class="tab-content">
        <!-- Upload Tab -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel">
            <form id="upload-form">
                <!-- Updated Drop Area -->
                <div id="drop-area">
                    <div class="upload-icon-container">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    </div>
                    <p>Upload a photo of your waste item for AI analysis</p>
                    <input type="file" id="file-input" accept="image/*">
                    <button type="button" class="btn btn-primary mt-2 button-animation" id="select-file-btn">
                        <i class="fas fa-upload"></i> Select Image
                    </button>
                    <div class="supported-formats">
                        Supported: JPG, PNG, WEBP
                    </div>
                    <div class="upload-instructions">
                        Or drag and drop your image file here
                    </div>
                </div>
                
                <!-- Updated Preview Area -->
                <div id="preview">
                    <!-- The preview content will be dynamically inserted here -->
                </div>
                
                <!-- Updated Analyze Button Container -->
                <div id="analyze-btn-container">
                    <button type="button" class="btn btn-success button-animation" id="analyze-btn">
                        <i class="fas fa-search"></i> Analyze Image
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-container" id="loading">
        <div class="spinner"></div>
        <p class="mt-3">Analyzing your waste item...</p>
        <p class="text-muted small">This may take a few moments</p>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="error-message"></div>
    
    <!-- Results -->
    <div class="results-container" id="results">
        <div class="results-header">
            <i class="fas fa-recycle"></i>
            <h2>Analysis Results</h2>
        </div>
        
        <div class="results-grid">
            <div class="results-column">
                <div class="result-image" id="result-image-container">
                    <!-- Result image will be placed here -->
                </div>
                
                <div class="alert alert-success">
                    <p class="mb-1">This item is a <span class="waste-type" id="waste-type"></span> 
                       <span class="confidence" id="confidence"></span></p>
                    <p class="mb-0" id="item-scanned"></p>
                </div>
                
                <div class="guidelines">
                    <h4><i class="fas fa-info-circle"></i> Recycling Guidelines</h4>
                    <div id="guidelines-content"></div>
                </div>
            </div>
            
            <div class="results-column">
                <div id="gpt-analysis-container" class="gpt-analysis">
                    <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                    <!-- Analysis content will be dynamically inserted here -->
                </div>
                
                <div class="recycling-centers">
                    <h4><i class="fas fa-map-marker-alt"></i> Nearby Recycling Centers</h4>
                    <div id="centers-list"></div>
                </div>
            </div>
        </div>
        
        <div class="btn-next">
            <button class="btn btn-primary btn-lg button-animation" id="scan-another">
                <i class="fas fa-redo"></i> Scan Another Item
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const preview = document.getElementById('preview');
        const uploadForm = document.getElementById('upload-form');
        const analyzeBtnContainer = document.getElementById('analyze-btn-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        
        const wasteType = document.getElementById('waste-type');
        const confidence = document.getElementById('confidence');
        const guidelinesContent = document.getElementById('guidelines-content');
        const centersList = document.getElementById('centers-list');
        
        const scanAnother = document.getElementById('scan-another');
        
        let uploadedFile = null;
        let uploadedImageWidth = 0;
        let uploadedImageHeight = 0;
        
        // File Drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Enhanced visual feedback during file drop
        dropArea.addEventListener('dragenter', function(e) {
            preventDefaults(e);
            highlight();
            
            // Additional visual cue
            const uploadIcon = dropArea.querySelector('.upload-icon');
            if (uploadIcon) {
                uploadIcon.style.color = '#5CDB95';
                uploadIcon.style.transform = 'scale(1.2)';
            }
        });

        dropArea.addEventListener('dragleave', function(e) {
            preventDefaults(e);
            unhighlight();
            
            // Reset icon
            const uploadIcon = dropArea.querySelector('.upload-icon');
            if (uploadIcon) {
                uploadIcon.style.color = '';
                uploadIcon.style.transform = '';
            }
        });
        
        // Enhanced drop area highlight effect
        function highlight() {
            dropArea.classList.add('highlight');
            
            // Add scale effect
            dropArea.style.transform = 'scale(1.02)';
            dropArea.style.borderColor = '#5CDB95';
            dropArea.style.backgroundColor = 'rgba(92, 219, 149, 0.1)';
        }

        function unhighlight() {
            dropArea.classList.remove('highlight');
            
            // Remove scale effect
            dropArea.style.transform = '';
            dropArea.style.borderColor = '';
            dropArea.style.backgroundColor = '';
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].type.match('image.*')) {
                handleFiles(files);
            } else {
                showError('Please upload an image file (JPEG, PNG, etc.)');
            }
        }
        
        selectFileBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
            }
        });
        
        // Updated handleFiles function for better image preview
        function handleFiles(files) {
            const file = files[0];
            if (file.type.match('image.*')) {
                uploadedFile = file; // Store the file for later analysis
                const reader = new FileReader();
                
                // Format file size for display
                const fileSize = formatFileSize(file.size);
                const fileName = file.name;
                
                reader.onload = function(e) {
                    // Create a more sophisticated preview layout
                    preview.innerHTML = `
                        <div class="image-preview-wrapper">
                            <div class="image-preview-container">
                                <img src="${e.target.result}" alt="Preview">
                            </div>
                            <div class="upload-success-indicator">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="image-info-bar">
                                <span class="file-name">${fileName}</span>
                                <span class="file-size">${fileSize}</span>
                            </div>
                        </div>
                        <div class="image-preview-actions">
                            <button type="button" class="btn remove-image-btn" id="remove-image-btn">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>`;
                    
                    // Show analyze button with animation
                    analyzeBtnContainer.style.display = 'block';
                    
                    // Add event listener for remove button
                    document.getElementById('remove-image-btn').addEventListener('click', function() {
                        preview.innerHTML = '';
                        fileInput.value = '';
                        uploadedFile = null;
                        analyzeBtnContainer.style.display = 'none';
                    });
                    
                    // Preload image dimensions for better UI
                    const img = new Image();
                    img.onload = function() {
                        // Store dimensions for potential use later
                        uploadedImageWidth = this.width;
                        uploadedImageHeight = this.height;
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            } else {
                showError('Please select an image file (JPEG, PNG, etc.)');
                fileInput.value = '';
                preview.innerHTML = '';
                analyzeBtnContainer.style.display = 'none';
                uploadedFile = null;
            }
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // Update the animation for the analyze button
        analyzeBtn.addEventListener('mouseover', function() {
            this.innerHTML = '<i class="fas fa-search"></i> Ready to Analyze';
        });

        analyzeBtn.addEventListener('mouseout', function() {
            this.innerHTML = '<i class="fas fa-search"></i> Analyze Image';
        });
        
        // Analyze button click handler
        analyzeBtn.addEventListener('click', function() {
            if (uploadedFile) {
                analyzeImage(uploadedFile);
            } else {
                showError('Please upload an image first');
            }
        });
        
        // Form submission is now handled by the analyzeImage function
        function analyzeImage(file) {
            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);
            
            // Add a small delay to ensure loading animation is visible
            setTimeout(() => {
                fetch('/scan/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    console.log("Upload response status:", response.status);
                    if (!response.ok) {
                        return response.json().then(data => {
                            console.error("API error:", data);
                            throw new Error(data.error || 'Error analyzing image');
                        }).catch(err => {
                            console.error("JSON parse error:", err);
                            throw new Error('Error analyzing image: Invalid response format');
                        });
                    }
                    return response.json().catch(err => {
                        console.error("JSON parse error:", err);
                        throw new Error('Error analyzing image: Invalid response format');
                    });
                })
                .then(data => {
                    if (data.success) {
                        // Ensure we have a valid structure for display, create fallback if needed
                        if (!data.top_prediction) {
                            data.top_prediction = {
                                label: 'unknown',
                                confidence: 0.7
                            };
                        }
                        
                        // Scroll to results
                        displayResults(data);
                        setTimeout(() => {
                            results.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    } else {
                        console.error("API call succeeded but returned error:", data);
                        showError(data.error || 'Error analyzing image');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError(error.message || 'Error uploading image. Please try again.');
                })
                .finally(() => {
                    hideLoading();
                });
            }, 500); // 500ms delay to show loading animation
        }
        
        // Results handling
        function displayResults(data) {
            console.log("Scan results data:", data);
            
            results.style.display = 'block';
            errorMessage.style.display = 'none';
            
            try {
                const prediction = data.top_prediction;
                console.log("Top prediction:", prediction);
                
                if (!prediction) {
                    console.error("No prediction found in response");
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = 'Could not identify the item. Please try again with a clearer image.';
                    return;
                }
                
                // For uploaded files, don't show the image again - it's already in the preview
                const resultImageContainer = document.getElementById('result-image-container');
                if (resultImageContainer) {
                    resultImageContainer.innerHTML = '';
                }
                
                // Parse the material type from the label
                const itemLabel = prediction.label.replace(/_/g, ' ');
                console.log("Item label:", itemLabel);
                let materialType = 'Unknown';
                
                if (itemLabel.includes('plastic')) {
                    materialType = 'Plastic';
                } else if (itemLabel.includes('glass')) {
                    materialType = 'Glass';
                } else if (itemLabel.includes('paper') || itemLabel.includes('cardboard')) {
                    materialType = 'Paper/Cardboard';
                } else if (itemLabel.includes('metal') || itemLabel.includes('aluminum') || itemLabel.includes('steel')) {
                    materialType = 'Metal';
                } else if (itemLabel.includes('organic') || itemLabel.includes('food')) {
                    materialType = 'Organic';
                } else if (itemLabel.includes('electronic') || itemLabel.includes('e_waste')) {
                    materialType = 'Electronic';
                } else if (itemLabel.includes('textile') || itemLabel.includes('clothing')) {
                    materialType = 'Textile';
                }
                
                console.log("Material type:", materialType);
                
                // Display top prediction and material type
                if (wasteType) wasteType.textContent = itemLabel;
                if (confidence) confidence.textContent = `${Math.round(prediction.confidence * 100)}% confidence`;
                
                // Display what item was scanned
                const itemScannedEl = document.getElementById('item-scanned');
                if (itemScannedEl) {
                    itemScannedEl.innerHTML = `<strong>Item Scanned:</strong> ${data.item_name || itemLabel}`;
                }
                
                // Check for GPT-4o analysis results
                const gptAnalysisContainer = document.getElementById('gpt-analysis-container');
                
                // Log the entire data object to debug
                console.log("Complete response data:", data);
                
                // Always generate analysis content, with or without GPT data
                if (gptAnalysisContainer) {
                    if (data.gpt_analysis && 
                      (data.gpt_analysis.material_composition?.length > 0 || 
                       data.gpt_analysis.recyclability?.length > 0 || 
                       data.gpt_analysis.disposal_suggestions?.length > 0)) {
                        
                        console.log("GPT analysis data found:", data.gpt_analysis);
                        
                        // Determine badge class based on waste type
                        const wasteTypeBadgeClass = `badge-${data.gpt_analysis.waste_type || 'mixed'}`;
                        
                        // Create HTML content for GPT analysis
                        let gptAnalysisHtml = `
                            <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                            <div class="mb-3">
                                <span class="badge ${wasteTypeBadgeClass} p-2" style="color: #11222a; font-weight: 700;">
                                    ${(data.gpt_analysis.waste_type || 'Unknown').toUpperCase()}
                                </span>
                            </div>
                        `;
                        
                        // Material Composition Section
                        if (data.gpt_analysis.material_composition && data.gpt_analysis.material_composition.length > 0) {
                            gptAnalysisHtml += `
                                <div class="gpt-analysis-section">
                                    <h5><i class="fas fa-atom"></i> Material Composition</h5>
                                    <ul>
                                        ${data.gpt_analysis.material_composition.map(item => `<li>${parseMarkdown(item)}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Recyclability Section
                        if (data.gpt_analysis.recyclability && data.gpt_analysis.recyclability.length > 0) {
                            gptAnalysisHtml += `
                                <div class="gpt-analysis-section">
                                    <h5><i class="fas fa-recycle"></i> Recyclability</h5>
                                    <ul>
                                        ${data.gpt_analysis.recyclability.map(item => `<li>${parseMarkdown(item)}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Disposal Suggestions Section
                        if (data.gpt_analysis.disposal_suggestions && data.gpt_analysis.disposal_suggestions.length > 0) {
                            gptAnalysisHtml += `
                                <div class="gpt-analysis-section">
                                    <h5><i class="fas fa-trash-alt"></i> Disposal Suggestions</h5>
                                    <ul>
                                        ${data.gpt_analysis.disposal_suggestions.map(item => `<li>${parseMarkdown(item)}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Set the HTML content
                        gptAnalysisContainer.innerHTML = gptAnalysisHtml;
                    } else {
                        console.log("No GPT analysis data found, generating standard analysis for material type:", materialType);
                        
                        // If no GPT analysis, display a standard analysis based on the waste type
                        let analysisMessage = "";
                        let recyclingTips = [];
                        let disposalSuggestions = [];
                        
                        // Generate material-specific analysis
                        if (materialType === 'Plastic') {
                            analysisMessage = "Plastic items are made from petroleum-based materials that can take hundreds of years to decompose naturally.";
                            recyclingTips = [
                                "Plastic items should be clean and dry before recycling",
                                "Remove any non-plastic components like metal caps",
                                "Check the recycling number on the bottom - numbers 1 (PET) and 2 (HDPE) are most widely accepted",
                                "Plastic bags and films often require special recycling programs"
                            ];
                            disposalSuggestions = [
                                "Rinse container to remove food residue",
                                "Remove and separate caps and lids if different material",
                                "Place in recycling bin (check local guidelines for specific types)",
                                "Consider reusing clean containers instead of disposing"
                            ];
                        } else if (materialType === 'Glass') {
                            analysisMessage = "Glass is made from natural materials like sand, soda ash, and limestone, and is 100% recyclable.";
                            recyclingTips = [
                                "Glass can be recycled endlessly without loss in quality or purity",
                                "Different colors of glass (clear, green, brown) may need to be separated",
                                "Rinse containers to remove food residue",
                                "Remove caps and lids as they are often made from different materials"
                            ];
                            disposalSuggestions = [
                                "Rinse container thoroughly",
                                "Remove any non-glass components",
                                "Place in glass recycling bin (sorted by color if required)",
                                "Be careful with broken glass - wrap in paper before disposal"
                            ];
                        } else if (materialType === 'Paper/Cardboard') {
                            analysisMessage = "Paper products are made from wood pulp and can be recycled 5-7 times before fibers become too short.";
                            recyclingTips = [
                                "Paper products should be clean and free of food residue",
                                "Remove any plastic windows or non-paper components",
                                "Flatten cardboard boxes to save space",
                                "Keep paper dry to maintain recyclability"
                            ];
                            disposalSuggestions = [
                                "Break down cardboard boxes to save space",
                                "Remove any tape, staples, or non-paper materials",
                                "Place clean paper in paper recycling bin",
                                "Compost heavily soiled paper if possible"
                            ];
                        } else if (materialType === 'Metal') {
                            analysisMessage = "Metal items like cans are highly recyclable materials that can be recycled indefinitely without degradation.";
                            recyclingTips = [
                                "Metal containers should be empty, clean, and dry",
                                "Labels can typically stay on metal cans",
                                "Aluminum cans are among the most valuable recyclable materials",
                                "Small metal items can be collected together in a larger metal container"
                            ];
                            disposalSuggestions = [
                                "Rinse containers to remove food residue",
                                "Crush cans to save space (optional)",
                                "Place in metal recycling bin",
                                "Consider separating different types of metals if required locally"
                            ];
                        } else if (materialType === 'Organic') {
                            analysisMessage = "Organic waste includes food scraps and yard waste that can be composted to create nutrient-rich soil.";
                            recyclingTips = [
                                "Organic waste can be composted at home or through municipal programs",
                                "Composting reduces methane emissions from landfills",
                                "Many cities have separate collection for organic waste",
                                "Both food scraps and yard waste can typically be composted together"
                            ];
                            disposalSuggestions = [
                                "Place in home compost bin or municipal organic waste bin",
                                "Layer with brown materials (leaves, paper) in home compost",
                                "Use compostable bags if required by local collection",
                                "Consider worm composting for apartment living"
                            ];
                        } else if (materialType === 'Electronic') {
                            analysisMessage = "Electronic waste contains valuable recoverable materials as well as potentially hazardous components.";
                            recyclingTips = [
                                "Electronics should never be thrown in regular trash",
                                "Many electronic retailers offer take-back programs",
                                "Data should be wiped from devices before recycling",
                                "E-waste recycling recovers valuable metals and prevents toxic materials from entering landfills"
                            ];
                            disposalSuggestions = [
                                "Take to designated e-waste recycling center",
                                "Use manufacturer or retailer take-back programs",
                                "Remove batteries before recycling if possible",
                                "Check for local e-waste collection events"
                            ];
                        } else {
                            analysisMessage = "This item should be disposed of according to local recycling guidelines.";
                            recyclingTips = [
                                "Check with your local recycling program for specific guidelines",
                                "When in doubt, keep it out of the recycling bin",
                                "Mixed materials are often difficult to recycle",
                                "Clean items before recycling whenever possible"
                            ];
                            disposalSuggestions = [
                                "Research proper disposal methods for your area",
                                "Contact local waste management for special items",
                                "Consider donation if the item is still usable",
                                "Separate components made of different materials if possible"
                            ];
                        }
                        
                        // Create detailed fallback analysis
                        gptAnalysisContainer.innerHTML = `
                            <h4><i class="fas fa-brain"></i> AI Analysis Results</h4>
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-atom"></i> Material Composition</h5>
                                <p>${analysisMessage}</p>
                            </div>
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-recycle"></i> Recyclability</h5>
                                <ul>
                                    ${recyclingTips.map(tip => `<li>${tip}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="gpt-analysis-section">
                                <h5><i class="fas fa-trash-alt"></i> Disposal Suggestions</h5>
                                <ul>
                                    ${disposalSuggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
                
                // Fetch guidelines from API
                console.log("Fetching guidelines for waste type:", prediction.label);
                const guidelinesContentEl = document.getElementById('guidelines-content');
                
                if (guidelinesContentEl) {
                    fetch(`/api/guidelines/${prediction.label}`)
                        .then(response => {
                            console.log("Guidelines response status:", response.status);
                            return response.json();
                        })
                        .then(data => {
                            console.log("Guidelines data:", data);
                            const guidelines = data.guidelines;
                            
                            let guidelinesHTML = '';
                            
                            if (guidelines) {
                                guidelinesHTML += `<div class="alert ${guidelines.recyclable ? 'alert-success' : 'alert-warning'}">
                                    <strong>${guidelines.recyclable ? 'Recyclable ♻️' : 'Not Recyclable ⚠️'}</strong>
                                </div>`;
                                
                                // Add material type information
                                guidelinesHTML += `<p><strong>Material:</strong> ${materialType}</p>`;
                                guidelinesHTML += `<p><strong>Preparation:</strong> ${guidelines.preparation}</p>`;
                                guidelinesHTML += `<p><strong>Bin:</strong> <span class="badge bg-${guidelines.bin_color === 'blue' ? 'primary' : guidelines.bin_color === 'green' ? 'success' : guidelines.bin_color === 'black' ? 'dark' : 'secondary'} p-2">${guidelines.bin_color.toUpperCase()} BIN</span></p>`;
                                
                                if (guidelines.facts) {
                                    guidelinesHTML += `<div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle me-2"></i> <strong>Did you know?</strong> ${guidelines.facts}
                                    </div>`;
                                }
                            } else {
                                guidelinesHTML = '<p>No specific guidelines available for this item.</p>';
                            }
                            
                            guidelinesContentEl.innerHTML = guidelinesHTML;
                            
                            // Also fetch nearby recycling centers
                            fetchRecyclingCenters(prediction.label);
                        })
                        .catch(error => {
                            console.error('Error fetching guidelines:', error);
                            if (guidelinesContentEl) {
                                guidelinesContentEl.innerHTML = '<p>Error loading recycling guidelines.</p>';
                            }
                        });
                }
            } catch (error) {
                console.error("Error displaying results:", error);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error displaying results. Please try again.';
            }
        }
        
        function fetchRecyclingCenters(wasteType) {
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    // Success callback
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        console.log("Getting recycling centers near: ", lat, lon);
                        
                        fetch(`/api/recycling-centers?lat=${lat}&lon=${lon}&waste_type=${wasteType}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log("Recycling centers data:", data);
                                displayRecyclingCenters(data.centers || []);
                            })
                            .catch(error => {
                                console.error('Error fetching recycling centers:', error);
                                displayRecyclingCenters([]);
                            });
                    },
                    // Error callback
                    function(error) {
                        console.error("Geolocation error:", error);
                        displayDefaultRecyclingCenters();
                    }
                );
            } else {
                console.error("Geolocation not supported");
                displayDefaultRecyclingCenters();
            }
        }
        
        function displayRecyclingCenters(centers) {
            const centersList = document.getElementById('centers-list');
            
            if (!centers || centers.length === 0) {
                centersList.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Visit the Centers tab to find where to dispose of this item.
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Display up to 3 centers
            centers.slice(0, 3).forEach(center => {
                const distance = center.distance ? 
                    `${center.distance.toFixed(1)} miles away` : 
                    '';
                    
                const address = center.address ? 
                    `<p class="mb-1"><i class="fas fa-map-marker-alt text-muted me-2"></i>${center.address}</p>` : 
                    '';
                    
                const phone = center.phone ? 
                    `<p class="mb-1"><i class="fas fa-phone text-muted me-2"></i>${center.phone}</p>` : 
                    '';
                    
                const website = center.website ? 
                    `<p class="mb-0"><i class="fas fa-globe text-muted me-2"></i><a href="${center.website}" target="_blank" rel="noopener">Website</a></p>` : 
                    '';
                    
                html += `
                    <div class="center-card">
                        <h5>${center.name || 'Recycling Center'}</h5>
                        ${distance ? `<p class="text-muted mb-2">${distance}</p>` : ''}
                        ${address}
                        ${phone}
                        ${website}
                    </div>
                `;
            });
            
            html += `
                <div class="text-center mt-3">
                    <a href="/centers" class="btn btn-outline-success">
                        <i class="fas fa-search-location"></i> Find More Centers
                    </a>
                </div>
            `;
            
            centersList.innerHTML = html;
        }
        
        function displayDefaultRecyclingCenters() {
            const centersList = document.getElementById('centers-list');
            
            centersList.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Visit the Centers tab to find where to dispose of this item.
                </div>
            `;
        }
        
        // Helpers
        function showLoading() {
            loading.style.display = 'block';
            results.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Add overlay to prevent interaction
            document.body.style.overflow = 'hidden';
            
            // Disable scan buttons to prevent multiple submissions
            if (analyzeBtn) analyzeBtn.disabled = true;
        }
        
        function hideLoading() {
            loading.style.display = 'none';
            document.body.style.overflow = '';
            
            // Re-enable scan buttons
            if (analyzeBtn) analyzeBtn.disabled = false;
        }
        
        function showError(message) {
            errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorMessage.style.display = 'block';
            
            // Automatically hide after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
            
            // Scroll to error message
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        // Reset and scan again
        if (scanAnother) {
            scanAnother.addEventListener('click', function() {
                // Hide results and clear preview
                results.style.display = 'none';
                preview.innerHTML = '';
                fileInput.value = '';
                uploadedFile = null;
                analyzeBtnContainer.style.display = 'none';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        
        // Parse markdown from the response
        function parseMarkdown(text) {
            if (!text) return '';
            
            // Replace ** for bold text (properly escaped)
            let parsedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Additional check to replace any remaining ** that weren't caught
            parsedText = parsedText.replace(/\*\*/g, '');
            
            return parsedText;
        }
    });
</script>
{% endblock %} 